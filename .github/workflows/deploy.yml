name: Deploy (repository_dispatch)

on:
  repository_dispatch:
    types: [deploy]

concurrency:
  group: deploy-game
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          script: |
            set -euo pipefail
            set -x

            SERVICE="${{ github.event.client_payload.service }}"
            IMAGE="${{ github.event.client_payload.image }}"
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

            echo "[deploy] service=${SERVICE}"
            echo "[deploy] image=${IMAGE}"
            echo "[deploy] user=$(whoami) host=$(hostname) home=${HOME}"

            [ -n "${SERVICE}" ] && [ -n "${IMAGE}" ]

            [ -d "${DEPLOY_PATH}" ]
            cd "${DEPLOY_PATH}"
            echo "[deploy] working_dir=$(pwd)"
            ls -la

            export COMPOSE_PROJECT_NAME="game"

            if [ "${SERVICE}" = "frontend" ]; then
              echo "${IMAGE}" | grep -q "/svelteweb:"
              KEY="FRONT_IMAGE"
              SVC="sveltekit"
            elif [ "${SERVICE}" = "backend" ]; then
              echo "${IMAGE}" | grep -q "/gameserver:"
              KEY="BACK_IMAGE"
              SVC="api"
            else
              echo "[deploy] Unknown service: ${SERVICE}"
              exit 1
            fi

            echo "[deploy] updating ${KEY} -> ${IMAGE}"
            if grep -q "^${KEY}=" .env; then
              sed -i "s|^${KEY}=.*|${KEY}=${IMAGE}|" .env
            else
              echo "${KEY}=${IMAGE}" >> .env
            fi

            echo "[deploy] docker compose config check"
            docker compose config >/dev/null

            echo "[deploy] docker compose pull ${SVC}"
            docker compose pull "${SVC}" || {
              echo "[deploy] pull failed. showing status/logs..."
              docker compose ps || true
              docker compose logs --no-color --tail=200 "${SVC}" || true
              exit 1
            }

            echo "[deploy] docker compose up -d --no-deps ${SVC}"
            docker compose up -d --no-deps "${SVC}" || {
              echo "[deploy] up failed. showing status/logs..."
              docker compose ps || true
              docker compose logs --no-color --tail=200 "${SVC}" || true
              exit 1
            }

            echo "[deploy] done. ps:"
            docker compose ps

            docker image prune -f || true
