name: Deploy (DEV)

on:
  repository_dispatch:
    types: [deploy-dev]

concurrency:
  group: deploy-game-dev
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          script: |
            set -euo pipefail
            set -x

            SERVICE="${{ github.event.client_payload.service }}"
            IMAGE="${{ github.event.client_payload.image }}"
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

            echo "[deploy-dev] service=${SERVICE}"
            echo "[deploy-dev] image=${IMAGE}"
            echo "[deploy-dev] user=$(whoami) host=$(hostname) home=${HOME}"

            [ -n "${SERVICE}" ] && [ -n "${IMAGE}" ]

            [ -d "${DEPLOY_PATH}" ]
            cd "${DEPLOY_PATH}"
            echo "[deploy-dev] working_dir=$(pwd)"
            ls -la

            export COMPOSE_PROJECT_NAME="game-dev"
            ENV_FILE=".env.dev"

            echo "[deploy-dev] using environment file: ${ENV_FILE}"

            if [ "${SERVICE}" = "frontend" ]; then
              echo "${IMAGE}" | grep -q "/svelteweb-dev:"
              KEY="FRONT_IMAGE"
              SVC="sveltekit"
            elif [ "${SERVICE}" = "backend" ]; then
              echo "${IMAGE}" | grep -q "/gameserver-dev:"
              KEY="BACK_IMAGE"
              SVC="api"
            else
              echo "[deploy-dev] Unknown service: ${SERVICE}"
              exit 1
            fi

            echo "[deploy-dev] updating ${KEY} -> ${IMAGE}"
            if grep -q "^${KEY}=" "${ENV_FILE}"; then
              sed -i "s|^${KEY}=.*|${KEY}=${IMAGE}|" "${ENV_FILE}"
            else
              echo "${KEY}=${IMAGE}" >> "${ENV_FILE}"
            fi

            echo "[deploy-dev] docker compose config check"
            docker compose --env-file "${ENV_FILE}" config >/dev/null

            echo "[deploy-dev] docker compose pull ${SVC}"
            docker compose --env-file "${ENV_FILE}" pull "${SVC}" || {
              echo "[deploy-dev] pull failed. showing status/logs..."
              docker compose --env-file "${ENV_FILE}" ps || true
              docker compose --env-file "${ENV_FILE}" logs --no-color --tail=200 "${SVC}" || true
              exit 1
            }

            echo "[deploy-dev] docker compose up -d --no-deps ${SVC}"
            docker compose --env-file "${ENV_FILE}" up -d --no-deps "${SVC}" || {
              echo "[deploy-dev] up failed. showing status/logs..."
              docker compose --env-file "${ENV_FILE}" ps || true
              docker compose --env-file "${ENV_FILE}" logs --no-color --tail=200 "${SVC}" || true
              exit 1
            }

            echo "[deploy-dev] done. ps:"
            docker compose --env-file "${ENV_FILE}" ps

            docker image prune -f || true
